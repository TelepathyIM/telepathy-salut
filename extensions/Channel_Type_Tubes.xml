<?xml version="1.0" ?>
<node name="/Channel_Type_Tubes" xmlns:tp="http://telepathy.freedesktop.org/wiki/DbusSpec#extensions-v0">
  <tp:copyright>
    Copyright (C) 2007 Collabora Limited
  </tp:copyright>
  <tp:license>
    This library is free software; you can redistribute it and/or
modify it under the terms of the GNU Lesser General Public
License as published by the Free Software Foundation; either
version 2.1 of the License, or (at your option) any later version.

This library is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
Library General Public License for more details.

You should have received a copy of the GNU Lesser General Public
License along with this library; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
  </tp:license>
  <interface name="org.freedesktop.Telepathy.Channel.Type.Tubes" tp:name-const="CHANNEL_TYPE_TUBES">
    <tp:requires interface="org.freedesktop.Telepathy.Channel"/>
    <tp:docstring xmlns="http://www.w3.org/1999/xhtml">
      <p>A "tube" is a mechanism for arbitrary data transfer. Two types of
        data transfer are currently specified: D-Bus messages, and streams of
        bytes. Each tube has a service name, which is a string specifying the
        kind of communication that takes place over it, and a dictionary of
        arbitrary parameters. Tube parameters are commonly used for bootstrap
        information such as usernames and passwords. Each tube is identified
        by a locally unique identifier.</p>

       <p>The Tubes channel type may be requested for handles of type
         HANDLE_TYPE_CONTACT and HANDLE_TYPE_ROOM.</p>

       <p>Stream tubes specify listening addresses using pairs of parameters
         with signature 'u', 'v', where the integer 'u' is a member of
         Socket_Address_Type and the v is dependent on the type of address.</p>
    </tp:docstring>

    <tp:enum name="Tube_Type">
      <tp:enumvalue suffix="DBus" value="0">
        <tp:docstring xmlns="http://www.w3.org/1999/xhtml">
          <p>An ordered reliable transport, for transporting D-Bus
            traffic.</p>

          <p>For each D-Bus tube, the connection manager listens on a D-Bus
            server address, as detailed in the D-Bus specification. On this
            address, it emulates a bus upon which each tube participant appears
            as an endpoint.</p>

          <p>The objects and interfaces which are expected to exist on the
            emulated bus depend on the well-known name; typically, either the
            participant who initiated the tube is expected to export the same
            objects/interfaces that would be exported by a service of that name
            on a bus, or all participants are expected to export those
            objects/interfaces.</p>
        </tp:docstring>
      </tp:enumvalue>

      <tp:enumvalue suffix="Stream" value="1">
        <tp:docstring xmlns="http://www.w3.org/1999/xhtml">
          <p>A transport for ordered, reliable data transfer, similar to
            SOCK_STREAM sockets.</p>

          <p>When accepting a Stream Unix tube, a new listening local socket is
            created. Each time the client connects to this socket, the
            connection manager of the initiator of the tube opens a new
            connection to its local socket. Both sides can then use this pair
            of sockets to communicate together.</p>
        </tp:docstring>
      </tp:enumvalue>
    </tp:enum>

    <tp:enum name="Tube_State">
      <tp:enumvalue suffix="Local_Pending" value="0">
        <tp:docstring>
          The tube is waiting to be accepted/closed locally.
        </tp:docstring>
      </tp:enumvalue>
      <tp:enumvalue suffix="Remote_Pending" value="1">
        <tp:docstring>
          The tube is waiting to be accepted/closed remotely.
        </tp:docstring>
      </tp:enumvalue>
      <tp:enumvalue suffix="Open" value="2">
        <tp:docstring>
          The tube is open for traffic.
        </tp:docstring>
      </tp:enumvalue>
    </tp:enum>

    <tp:enum name="Socket_Address_Type">
      <tp:enumvalue suffix="Unix" value="0">
        <tp:docstring>
          A Unix socket. The variant contains a byte-array, signature 'ay',
          containing the path of the socket.
        </tp:docstring>
      </tp:enumvalue>

      <tp:enumvalue suffix="Abstract_Unix" value="1">
        <tp:docstring>
          An abstract Unix socket. The variant contains a byte-array,
          signature 'ay', containing the path of the socket including the
          leading null byte.
        </tp:docstring>
      </tp:enumvalue>

      <tp:enumvalue suffix="IPv4" value="2">
        <tp:docstring>
          An IPv4 socket. The variant contains a struct with signature (sq)
          in which the string is an IPv4 dotted-quad address literal
          (and must not be a DNS name), while the 16-bit unsigned integer is
          the port number.
        </tp:docstring>
      </tp:enumvalue>

      <tp:enumvalue suffix="IPv6" value="3">
        <tp:docstring>
          An IPv6 socket. The variant contains a struct with signature (sq)
          in which the string is an IPv6 address literal as specified in
          RFC2373 (and must not be a DNS name), while the 16-bit unsigned
          integer is the port number.
        </tp:docstring>
      </tp:enumvalue>

    </tp:enum>

    <tp:enum name="Socket_Access_Control">
      <tp:enumvalue suffix="Localhost" value="0">
        <tp:docstring>
          The IP or Unix socket can be accessed by any local user (e.g.
          a Unix socket that accepts all local connections, or an IP socket
          listening on 127.0.0.1 (or ::1) or rejecting connections not from
          that address). The associated variant must be ignored.
        </tp:docstring>
      </tp:enumvalue>
      <tp:enumvalue suffix="Port" value="1">
        <tp:docstring>
          May only be used on IP sockets. The associated variant must contain
          a struct with signature (sq) containing the string form of an
          IP address of the appropriate version, and a port number.
          The socket can only be accessed if the connecting process has that
          address and port number; all other connections will be rejected.
        </tp:docstring>
      </tp:enumvalue>
      <tp:enumvalue suffix="Netmask" value="2">
        <tp:docstring>
          May only be used on IP sockets. The associated variant must contain
          a struct with signature (sy) containing the string form of an
          IP address of the appropriate version, and a prefix length "n".
          The socket can only be accessed if the first n bits of the
          connecting address match the first n bits of the given address.
        </tp:docstring>
      </tp:enumvalue>
      <tp:enumvalue suffix="Credentials" value="3">
        <tp:docstring xmlns="http://www.w3.org/1999/xhtml">
          <p>The connecting process must send a single zero (NUL) byte when
            it first connects, which is not considered to be part of the data
            stream. If the operating system uses sendmsg() with SCM_CREDS or
            SCM_CREDENTIALS to pass credentials over sockets, the connecting
            process must do so if possible; if not, it must still send the
            byte.</p>

          <p>The listening process will disconnect the connection unless it
            can determine by OS-specific means that the connecting process
            has the same user ID as the listening process.</p>

          <p>The associated variant must be ignored.</p>
        </tp:docstring>
      </tp:enumvalue>
    </tp:enum>

    <method name="GetAvailableStreamTubeTypes">
      <tp:docstring>List the available address types and access-control types
        for stream tubes.</tp:docstring>
      <arg direction="out" type="a{uau}">
        <tp:docstring xmlns="http://www.w3.org/1999/xhtml">
          <p>A mapping from address types (members of Socket_Address_Type) to
          arrays of access-control type (members of Socket_Access_Control)
          that the connection manager supports for stream tubes with that
          address type. For simplicity, if a CM supports offering a
          particular type of tube, it is assumed to support accepting it.</p>

          <p>A typical value for a host without IPv6 support:</p>

          <pre>
            {
              Socket_Address_Type_IPv4:
                [Socket_Access_Control_Localhost, Socket_Access_Control_Port,
                 Socket_Access_Control_Netmask],
              Socket_Address_Type_Unix:
                [Socket_Access_Control_Localhost, Socket_Access_Control_Credentials]
            }
          </pre>

          <p>If stream tubes are not supported, this will be an empty
            dictionary.</p>
        </tp:docstring>
      </arg>
    </method>

    <method name="GetAvailableTubeTypes">
      <arg direction="out" type="au" tp:type="Tube_Type[]">
        <tp:docstring>
          An array of the available tube types, as defined by the Tube_Type
          enum.
        </tp:docstring>
      </arg>
    </method>

    <method name="ListTubes">
      <arg direction="out" type="a(uuusa{sv}u)">
        <tp:docstring>
         Return an array of tuples, each representing a tube, with the
         following members:

         <ul>
           <li>the tube's ID</li>
           <li>the tube's initiator</li>
           <li>the tube's type</li>
           <li>the tube's service</li>
           <li>the tube's parameters</li>
           <li>the tube's state</li>
         </ul>
        </tp:docstring>
      </arg>
    </method>

    <method name="OfferDBusTube">
      <tp:docstring>
        Offers a D-Bus tube providing the service specified.
      </tp:docstring>
      <arg direction="in" name="service" type="s">
        <tp:docstring>
          A string representing the service name that will be used over the
          tube.
          It should be a well-known D-Bus service name, of the form
          com.example.ServiceName.
        </tp:docstring>
      </arg>
      <arg direction="in" name="parameters" type="a{sv}">
        <tp:docstring>
          A dictionary of properties for the new tube; the allowable keys,
          types and values are defined by the service. Connection managers
          must support the value being any primitive (non-container)
          D-Bus type, or a byte array 'ay'.
        </tp:docstring>
      </arg>
      <arg direction="out" type="u">
        <tp:docstring>
          The ID of the new tube.
        </tp:docstring>
      </arg>
      <tp:possible-errors>
        <tp:error name="org.freedesktop.Telepathy.Error.NetworkError"/>
        <tp:error name="org.freedesktop.Telepathy.Error.NotAvailable">
          <tp:docstring>
            The contact associated with this channel doesn't have tubes
            capabilities.
          </tp:docstring>
        </tp:error>
        <tp:error name="org.freedesktop.Telepathy.Error.NotImplemented">
          <tp:docstring>
            The connection manager doesn't support D-Bus tubes.
          </tp:docstring>
        </tp:error>
      </tp:possible-errors>
    </method>

    <method name="OfferStreamTube">
      <tp:docstring>
        Offer a stream tube exporting the local socket specified.
      </tp:docstring>
      <arg direction="in" name="service" type="s">
        <tp:docstring xmlns="http://www.w3.org/1999/xhtml">
          A string representing the service name that will be used over the
          tube.
          It should be a well-known TCP service name as defined by
          <a href="http://www.dns-sd.org/ServiceTypes.html">
            http://www.dns-sd.org/ServiceTypes.html</a>, for instance
          "rsync" or "daap".
        </tp:docstring>
      </arg>
      <arg direction="in" name="parameters" type="a{sv}">
        <tp:docstring xmlns="http://www.w3.org/1999/xhtml">
          <p>A dictionary of properties for the new tube; the allowable keys,
          types and values are defined by the service. Connection managers
          must support the value being any primitive (non-container)
          D-Bus type, or a byte array 'ay'.</p>
          <p>These should usually be the same key-value pairs specified for
          use in the DNS-SD TXT record for that service.</p>
        </tp:docstring>
      </arg>
      <arg direction="in" name="address_type" type="u" tp:type="Socket_Address_Type">
        <tp:docstring>
          The type of the listening address of the local service, as a member of
          Socket_Address_Type.
        </tp:docstring>
      </arg>
      <arg direction="in" name="address" type="v">
        <tp:docstring>
          The listening address of the local service, as indicated by the
          address_type.
        </tp:docstring>
      </arg>
      <arg direction="in" name="access_control" type="u" tp:type="Socket_Access_Control">
        <tp:docstring>
          The access control the local service applies to the local socket,
          specified so the connection manager can behave appropriately
          when it connects.
        </tp:docstring>
      </arg>
      <arg direction="in" name="access_control_param" type="v">
        <tp:docstring>
          A parameter for the access control type, to be interpreted as
          specified in the documentation for the Socket_Access_Control enum.
        </tp:docstring>
      </arg>
      <arg direction="out" type="u">
        <tp:docstring>
          The ID of the new tube.
        </tp:docstring>
      </arg>
      <tp:possible-errors>
        <tp:error name="org.freedesktop.Telepathy.Error.NetworkError"/>
        <tp:error name="org.freedesktop.Telepathy.Error.NotAvailable">
          <tp:docstring>
            The contact associated with this channel doesn't have tube
            capabilities.
          </tp:docstring>
        </tp:error>
        <tp:error name="org.freedesktop.Telepathy.Error.NotImplemented">
          <tp:docstring>
            The connection manager doesn't support stream tubes, or
            does not support the given address type or access-control type.
          </tp:docstring>
        </tp:error>
      </tp:possible-errors>
    </method>

    <signal name="NewTube">
      <tp:docstring>
        Emitted when a tube is created.
      </tp:docstring>
      <arg name="id" type="u">
        <tp:docstring>
          The ID of the new tube.
        </tp:docstring>
      </arg>
      <arg name="initiator" type="u" tp:type="Contact_Handle">
        <tp:docstring>
          The handle of the contact who initiated the tube.
        </tp:docstring>
      </arg>
      <arg name="type" type="u" tp:type="Tube_Type">
        <tp:docstring>
          The tube type, as defined by the Tube_Type enum.
        </tp:docstring>
      </arg>
      <arg name="service" type="s">
        <tp:docstring>
          A string representing the service that will be used over the tube.
        </tp:docstring>
      </arg>
      <arg name="parameters" type="a{sv}">
        <tp:docstring>
          The new tube's properties.
        </tp:docstring>
      </arg>
      <arg name="state" type="u" tp:type="Tube_State">
        <tp:docstring>
          The new tube's state.
        </tp:docstring>
      </arg>
    </signal>

    <method name="AcceptDBusTube">
      <tp:docstring>
        Accept a D-Bus tube that's in the "local pending" state. The
        connection manager will attempt to open the tube. The tube remains in
        the "local pending" state until the TubeStateChanged signal is
        emitted.
      </tp:docstring>
      <arg direction="in" name="id" type="u">
        <tp:docstring>
          The ID of the tube to accept.
        </tp:docstring>
      </arg>
      <arg direction="out" name="address" type="s">
        <tp:docstring>
          The string describing the address of the private bus. The client
          should not attempt to connect to the address until the tube is open.
        </tp:docstring>
      </arg>
      <tp:possible-errors>
        <tp:error name="org.freedesktop.Telepathy.Error.InvalidArgument">
          <tp:docstring>
            The given tube ID is invalid or does not refer to a D-Bus
            tube.
          </tp:docstring>
        </tp:error>
      </tp:possible-errors>
    </method>

    <method name="AcceptStreamTube">
      <tp:docstring>
        Accept a stream tube that's in the "local pending" state. The
        connection manager will attempt to open the tube. The tube remains in
        the "local pending" state until the TubeStateChanged signal is
        emitted.
      </tp:docstring>
      <arg direction="in" name="id" type="u">
        <tp:docstring>
          The ID of the tube to accept.
        </tp:docstring>
      </arg>
      <arg direction="in" name="address_type" type="u" tp:type="Socket_Address_Type">
        <tp:docstring>
          The type of address the connection manager should listen on.
        </tp:docstring>
      </arg>
      <arg direction="in" name="access_control" type="u" tp:type="Socket_Access_Control">
        <tp:docstring>
          The type of access control the connection manager should apply to
          the socket.
        </tp:docstring>
      </arg>
      <arg direction="in" name="access_control_param" type="v">
        <tp:docstring>
          A parameter for the access control type, to be interpreted as
          specified in the documentation for the Socket_Access_Control enum.
        </tp:docstring>
      </arg>
      <arg direction="out" name="address" type="v">
        <tp:docstring>
          The address on which the connection manager will listen for
          connections to this tube. The client should not attempt to connect
          to the address until the tube is open.
        </tp:docstring>
      </arg>

      <tp:possible-errors>
        <tp:error name="org.freedesktop.Telepathy.Error.InvalidArgument">
          <tp:docstring>
            The given tube ID is invalid or does not refer to a stream
            tube.
          </tp:docstring>
        </tp:error>
        <tp:error name="org.freedesktop.Telepathy.Error.NotImplemented">
          <tp:docstring>
            The given address type or access-control mechanism is not supported.
          </tp:docstring>
        </tp:error>
      </tp:possible-errors>
    </method>

    <signal name="TubeStateChanged">
      <tp:docstring>
        Emitted when the state of a tube changes.
      </tp:docstring>
      <arg name="id" type="u">
        <tp:docstring>
          The ID of the tube that changed state.
        </tp:docstring>
      </arg>
      <arg name="state" type="u" tp:type="Tube_State">
        <tp:docstring>
          The new state of the tube; see the Tube_State enumeration.
        </tp:docstring>
      </arg>
    </signal>

    <method name="CloseTube">
      <tp:docstring>
        Close a tube.
      </tp:docstring>
      <arg direction="in" name="id" type="u">
        <tp:docstring>
          The ID of the tube to close.
        </tp:docstring>
      </arg>
      <tp:possible-errors>
        <tp:error name="org.freedesktop.Telepathy.Error.InvalidArgument" />
      </tp:possible-errors>
    </method>

    <signal name="TubeClosed">
      <tp:docstring>
       Emitted when a tube has been closed. The ID of a closed tube is no
       longer valid. The ID may later be reused for a new tube.
      </tp:docstring>
      <arg name="id" type="u">
        <tp:docstring>
          The ID of the tube that was closed.
        </tp:docstring>
      </arg>
    </signal>

    <method name="GetDBusTubeAddress">
      <tp:docstring>
        For a D-Bus tube, return a string describing the address of the
        private bus.
      </tp:docstring>
      <arg direction="in" name="id" type="u">
        <tp:docstring>
          The ID of the tube to get an address for.
        </tp:docstring>
      </arg>
      <arg direction="out" type="s">
        <tp:docstring>
          The bus address.
        </tp:docstring>
      </arg>
      <tp:possible-errors>
        <tp:error name="org.freedesktop.Telepathy.Error.InvalidArgument">
          <tp:docstring>
            The tube is not a D-Bus tube.
          </tp:docstring>
        </tp:error>
        <tp:error name="org.freedesktop.Telepathy.Error.NotAvailable">
          <tp:docstring>
            This tube is not in the "open" state.
          </tp:docstring>
        </tp:error>
      </tp:possible-errors>
    </method>

    <method name="GetDBusNames">
      <tp:docstring>
        For a D-Bus tube, obtain a mapping between contact handles and their
        unique bus names on this tube.
      </tp:docstring>
      <arg direction="in" name="id" type="u">
        <tp:docstring>
          The ID of the tube to get names for.
        </tp:docstring>
      </arg>
      <arg direction="out" type="a(us)">
        <tp:docstring>
          An array of structures, each containing a contact handle and a D-Bus
          bus name.
        </tp:docstring>
      </arg>
      <tp:possible-errors>
        <tp:error name="org.freedesktop.Telepathy.Error.InvalidArgument">
          <tp:docstring>
            The tube is not a D-Bus tube.
          </tp:docstring>
        </tp:error>
        <tp:error name="org.freedesktop.Telepathy.Error.NotAvailable">
          <tp:docstring>
            This tube is not in the "open" state.
          </tp:docstring>
        </tp:error>
      </tp:possible-errors>
    </method>

    <signal name="DBusNamesChanged">
      <tp:docstring>
        Emitted on a D-Bus tube when a participant opens or closes the tube.
      </tp:docstring>
      <arg name="id" type="u">
        <tp:docstring>
          The ID of the tube whose names have changed.
        </tp:docstring>
      </arg>
      <arg name="added" type="a(us)">
        <tp:docstring>
          Array of handles and D-Bus names of new participants.
        </tp:docstring>
      </arg>
      <arg name="removed" type="au" tp:type="Contact_Handle[]">
        <tp:docstring>
          Array of handles of former participants.
        </tp:docstring>
      </arg>
    </signal>

    <method name="GetStreamTubeSocketAddress">
      <tp:docstring>
        For a stream tube, obtain the address of the socket used to
        communicate over this tube.
      </tp:docstring>
      <arg direction="in" name="id" type="u">
        <tp:docstring>
          The ID of the stream tube to get the socket for.
        </tp:docstring>
      </arg>
      <arg direction="out" name="address_type" type="u" tp:type="Socket_Address_Type">
        <tp:docstring>
          The type of the listening address of the socket, as a member of
          Socket_Address_Type.
        </tp:docstring>
      </arg>
      <arg direction="out" name="address" type="v">
        <tp:docstring>
          The listening address of the socket, as indicated by the
          address_type.
        </tp:docstring>
      </arg>
      <tp:possible-errors>
        <tp:error name="org.freedesktop.Telepathy.Error.InvalidArgument">
          <tp:docstring>
            The tube is not a stream tube.
          </tp:docstring>
        </tp:error>
        <tp:error name="org.freedesktop.Telepathy.Error.NotAvailable">
          <tp:docstring>
            This tube is not in the "open" state.
          </tp:docstring>
        </tp:error>
      </tp:possible-errors>
    </method>

    <signal name="StreamTubeNewConnection">
      <tp:docstring>
        Emitted on a stream tube when a participant opens a new connection
        to its socket.
      </tp:docstring>
      <arg name="id" type="u">
        <tp:docstring>
          The ID of the tube
        </tp:docstring>
      </arg>
      <arg name="handle" type="u" tp:type="Contact_Handle">
        <tp:docstring>
          The handle of the participant who opened the new connection
        </tp:docstring>
      </arg>
    </signal>

    <method name="OfferTube">
      <tp:docstring>
        Offers a tube providing the service specified, over a tube of the
        specified type. In practice, this will only work for D-Bus tubes.
        DEPRECATED: use OfferDBusTube instead.
      </tp:docstring>
      <arg direction="in" name="type" type="u" tp:type="Tube_Type">
        <tp:docstring>
          The type of tube wanted, one of the values from
          the Tube_Type enum.
        </tp:docstring>
      </arg>
      <arg direction="in" name="service" type="s">
        <tp:docstring>
          A string representing the service that will be used over the tube.
        </tp:docstring>
      </arg>
      <arg direction="in" name="parameters" type="a{sv}">
        <tp:docstring>
          A dicionary of properties for the new tube.
        </tp:docstring>
      </arg>
      <arg direction="out" type="u">
        <tp:docstring>
          The ID of the new tube.
        </tp:docstring>
      </arg>
    </method>

   <method name="AcceptTube">
      <tp:docstring>
        Accept a tube that's in the "local pending" state. The connection
        manager will attempt to open the tube. The tube remains in the
        "local pending" state until the TubeStateChanged signal is emitted.
        In practice, this will only work for D-Bus tubes.
        DEPRECATED: use AcceptDBusTube instead.
      </tp:docstring>
      <arg direction="in" name="id" type="u">
        <tp:docstring>
          The ID of the tube to accept.
        </tp:docstring>
      </arg>
      <tp:possible-errors>
        <tp:error name="org.freedesktop.Telepathy.Error.InvalidArgument" />
      </tp:possible-errors>
    </method>

    <method name="GetDBusServerAddress">
      <tp:docstring>
        For a D-Bus tube, return a string describing the address of the
        private bus.
      </tp:docstring>
      <arg direction="in" name="id" type="u">
        <tp:docstring>
          The ID of the tube to get an address for.
        </tp:docstring>
      </arg>
      <arg direction="out" type="s">
        <tp:docstring>
          The bus address.
        </tp:docstring>
      </arg>
      <tp:possible-errors>
        <tp:error name="org.freedesktop.Telepathy.Error.InvalidArgument">
          <tp:docstring>
            The tube is not a D-Bus tube.
          </tp:docstring>
        </tp:error>
        <tp:error name="org.freedesktop.Telepathy.Error.NotAvailable">
          <tp:docstring>
            This tube is not in the "open" state.
          </tp:docstring>
        </tp:error>
      </tp:possible-errors>
    </method>

  </interface>

</node>
<!-- vim:set sw=2 sts=2 et ft=xml: -->
